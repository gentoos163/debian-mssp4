#!/bin/sh

set -eu

auto () {
	for P in $(find /sys/bus/iio/devices -name 'iio:device*'); do grep -q als $P/name && break; done

	grep -q als $P/name || { echo 80; return; }

	# reading sensors (such as the ALS) occasionally takes a long time too due
	# to hardware glitching and it sometimes comes back with zero
	while true; do
	        RAW=$(cat $P/in_intensity_both_raw)
	        [ $RAW -eq 0 ] || break
	done

	## Using Fuzzy Logic and Light-Sensor for Automatic Adjustment of Backlight Brightness in a Mobile Computer
	## Cuing-Hung Cheng and Ying-Wen Bai
	## Graduate Institute of Applied Science and Engineering, Fu-Jen Catholic University, Taiwan
	## http://cs.ee.fju.edu.tw/paper/201211.pdf
	# original, with a '+1' safety
	#echo "27.05+9.932*l(1+$RAW)" | bc -l | cut -d. -f1
	# customised
	echo "15+7.5*l(1+$RAW/2)" | bc -l | cut -d. -f1
}

backlight_set () {
	xbacklight -time 50 $1%
}
backlight_get () {
	xbacklight -get | cut -d. -f1
}

[ "${1:-}" ] || set -- =$(auto)

backlight_set $1
backlight_get

exit 0
